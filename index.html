# app.py
from flask import Flask, request, jsonify, render_template_string
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import numpy as np

app = Flask(__name__)

# --- Simple knowledge base (आप इसे बढ़ा/बदल सकते हो) ---
kb = [
    "Namaste! Main ek simple chatbot hoon. Aap se milkar khushi hui.",
    "Main Python, HTML, CSS aur basic programming mein madad kar sakta hoon.",
    "Agar aap AI seekhna chahte ho to main projects aur tutorials bata sakta hoon.",
    "Termux par Python chalane ke liye 'pkg install python' use kar sakte ho.",
    "Web development mein HTML, CSS aur JavaScript kaafi jaruri hain.",
    "TensorFlow aur PyTorch deep learning libraries hain.",
    "Aap mujhe koi sawaal pooch sakte ho, main koshish karunga jawab dene ki."
]

# Precompute TF-IDF for KB
vectorizer = TfidfVectorizer().fit(kb)
kb_vecs = vectorizer.transform(kb)

def get_response(user_text, top_k=1, threshold=0.2):
    user_vec = vectorizer.transform([user_text])
    sims = cosine_similarity(user_vec, kb_vecs).flatten()
    idx = np.argmax(sims)
    score = sims[idx]
    if score >= threshold:
        return kb[idx], float(score)
    else:
        # fallback: simple echo / suggestion
        return "Maaf karo — mujhe iske baare mein nahi pata. Kya aap thoda aur bata sakte ho?", float(score)

# Minimal web UI (single file HTML)
HTML = """
<!doctype html>
<title>Simple AI Chatbot</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width:700px; margin:auto; }
  .chat { border:1px solid #ddd; padding:10px; height:400px; overflow:auto; background:#fafafa; }
  .user { color: blue; }
  .bot { color: green; }
  form { margin-top:10px; display:flex; }
  input[type=text]{ flex:1; padding:8px; }
  button{ padding:8px 12px; }
</style>
<h1>Simple AI Chatbot</h1>
<div class="chat" id="chat"></div>
<form id="f" onsubmit="send(event)">
  <input id="txt" autocomplete="off" placeholder="Message likho..." />
  <button>Send</button>
</form>
<script>
function addLine(who, text){
  const d=document.getElementById('chat');
  const div=document.createElement('div');
  div.innerHTML = '<strong class="'+who+'">'+who+':</strong> '+text;
  d.appendChild(div);
  d.scrollTop = d.scrollHeight;
}
async function send(e){
  e.preventDefault();
  const t=document.getElementById('txt');
  if(!t.value) return;
  addLine('You', t.value);
  const resp = await fetch('/api/chat', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({message: t.value})
  });
  const j = await resp.json();
  addLine('Bot', j.reply + ' <small>(score: '+j.score.toFixed(2)+')</small>');
  t.value='';
}
</script>
"""

@app.route("/")
def index():
    return render_template_string(HTML)

@app.route("/api/chat", methods=["POST"])
def api_chat():
    data = request.get_json() or {}
    msg = data.get("message", "")
    reply, score = get_response(msg)
    return jsonify({"reply": reply, "score": score})

if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=5000)